<html>
  <head>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body onload="consultGeneralInfo()">
    <div id="app">
      <div class="header">
        <div class="logo">
          <img src="./static/images/koinos-logo.png" />
        </div>
        <div class="info flex-row">
          <div class="mini-card flex-row">
            <div class="title">
              <img src="./static/images/ethereum-icon.svg" alt="">
              ERC20
            </div>
            <div class="label">Accounts</div>
            <div id="totalEthAccounts" class="value">...</div>
            <div class="label">Claimed</div>
            <div id="ethAccountsClaimed" class="value">...</div>
          </div>
          <div class="mini-card flex-row">
            <div class="title">
              <img src="./static/images/koinos-icon-purple.svg" alt="">
              KOIN
            </div>
            <div class="label">Tokens</div>
            <div id="totalKoin" class="value">...</div>
            <div class="label">Claimed</div>
            <div id="koinClaimed" class="value">...</div>
          </div>
        </div>
      </div>
      <div class="wrapper">
        <div class="left">
          <div class="group">
            <h2>KOIN Token Claiming</h2>
            <p>Welcome to the Koinos token claiming application. Here you will be able to connect your ERC20 wallet containing KOIN and claim your native KOIN tokens on the Koinos blockchain.</p>
          </div>
          <div class="group">
            <select v-model="category">
              <option
                v-for="option in categories"
                :value="option"
                :key="option"
                :selected="option === category"
              >{{ option }}</option>
            </select>
          </div>
          <div class="group">
            <p><div class="bold">Step One:</div> Connect your metamask wallet containing the KOIN ERC20 tokens</p>
            <button onclick="connectMetamask()"><img src="./static/images/metamask-logo.svg" alt=""> Connect Metamask</button>
          </div>
            <div class="group">
              <p><div class="bold">Step Two:</div> check the address containing the KOIN ERC20 tokens.</p>
              <div class="input-group">
                <input type="text" id="inputEthAddress" placeholder="Ethereum Address"/>
                <button onclick="consultClaim()" class="">Verify</button>
              </div>
            </div>
          <div class="group">
            <p><div class="bold">Step Three:</div> Connect your Kondor wallet</p>
            <div class="button-group">
              <button onclick="connectKondor()"> 
                <svg width="19" height="17" viewBox="0 0 19 17" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path fill-rule="evenodd" clip-rule="evenodd" d="M5.99873 1.28487C5.98747 2.06991 6.42061 2.92927 7.2112 4.13351C7.5616 5.49754 8.09706 6.59242 8.81195 7.81067C8.60128 9.31136 9.00246 10.8485 9.64584 12.3149C9.47883 12.6232 9.38107 12.8431 9.35422 13.1714C8.79147 13.6487 8.36025 14.2107 8.03919 14.8438C7.34116 14.7017 6.7027 14.4774 6.11587 14.182C5.68578 13.7481 5.3552 13.2525 5.20052 12.7268C5.8757 12.5542 6.57166 12.2233 7.16318 11.6979C6.26406 11.9052 5.42351 11.9232 4.6945 11.6852C4.10559 10.8547 3.8202 9.91509 3.918 8.97118C4.68638 9.57745 5.55763 9.9374 6.55626 9.79419C5.46642 9.26069 4.47912 8.57448 3.74843 7.63239C3.6975 6.73208 3.92769 5.95012 4.28826 5.26187C4.94742 6.24089 5.81902 6.97502 6.71618 7.59188C5.82809 6.70048 5.12158 5.60228 4.60232 4.42077C4.81834 3.20638 5.28213 2.17936 5.99873 1.28487Z" fill="#7161EF"/>
                  <path fill-rule="evenodd" clip-rule="evenodd" d="M12.5442 1.28487C12.5555 2.06991 12.1224 2.92927 11.3318 4.13351C10.9814 5.49754 10.4459 6.59241 9.73102 7.81067C9.89639 8.98863 9.68478 10.1891 9.27494 11.3601C9.22023 11.5163 9.24829 13.2224 9.27748 13.2483C9.7971 13.7087 10.1998 14.2444 10.5038 14.8438C11.2018 14.7017 11.8403 14.4774 12.4271 14.182C12.8572 13.7481 13.1878 13.2525 13.3425 12.7268C12.6673 12.5542 11.9713 12.2233 11.3798 11.6979C12.2789 11.9052 13.1195 11.9232 13.8485 11.6852C14.4374 10.8547 14.7228 9.91509 14.625 8.97118C13.8566 9.57745 12.9853 9.9374 11.9867 9.79419C13.0765 9.26068 14.0638 8.57448 14.7945 7.63239C14.8455 6.73208 14.6153 5.95012 14.2547 5.26187C13.5956 6.24089 12.724 6.97501 11.8268 7.59188C12.7149 6.70047 13.4214 5.60228 13.9406 4.42077C13.7246 3.20638 13.2608 2.17936 12.5442 1.28487Z" fill="#7161EF"/>
                </svg>
                Connect Kondor
              </button>
              <span>
                <a href="">CLI Instructions</a>
              </span>
            </div>
          </div>
          <div id="group-claim" class="group">
            <p><div class="bold">Step Four:</div> Claim your KOIN tokens</p>
            <button onclick="claimKoins()">CLAIM KOIN</button>
          </div>
        </div>
        <div class="right">
          <div id="erc-info">
            <div class="title">ERC20 Info</div>
            <div class="body">
              <table>
                <tr>
                  <td>Address</td>
                  <td id="ethAddress" class="align-right"></td>
                </tr>
                <tr>
                  <td>KOIN</td>
                  <td id="ethKoinBalance" class="align-right">
                  </td>
                </tr>
                <tr>
                  <td>Claiming Balance</td>
                  <td id="claimed" class="align-right"></td>
                </tr>
              </table>
            </div>
          </div>
          <div id="kondor-info">
            <div class="title">Koinos Info</div>
            <div class="body">
              <table>
                <tr>
                  <td>Address</td>
                  <td id="koinAddress" class="align-right"></td>
                </tr>
              </table>
            </div>
          </div>
          <div class="messages">
            <div id="message" class="message"></div>
          </div>
        </div>
      </div>      
    </div>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script
      src="https://cdn.ethers.io/lib/ethers-5.0.umd.min.js"
      type="text/javascript"
    ></script>
    <script src="js/kondor.js"></script>
    <script src="js/koinos.js"></script>
    <script>
      const { createApp } = Vue
    
      createApp({
        data() {
          return {
            active: false,
            categories: ['Koinos', 'Someone Else'], event: {category: ''},
          }
        },methods: {
      toggle () {
        this.active = !this.active
      }
    }
      }).mount('#app')
    </script>
    <script>
      const inputEthAddress = document.getElementById("inputEthAddress")
      const elEthAddress = document.getElementById("ethAddress")
      const elMessage = document.getElementById("message")
      const elEthKoinBalance = document.getElementById("ethKoinBalance")
      const elKoinAddress = document.getElementById("koinAddress")
      const elClaimed = document.getElementById("claimed")
      let koinAddress
      let metamaskProvider

      const notification = {
        hide: () => elMessage.setAttribute("style", "display:none;"),
        show: (msg) => {
          elMessage.innerHTML = msg
          elMessage.setAttribute("style", "display:block;")
        },
      }
      notification.hide()

      function getMetamaskProvider() {
        if (typeof window.ethereum === "undefined") {
          throw new Error("Metamask is not installed")
        }
        return new ethers.providers.Web3Provider(window.ethereum)
      }

      async function consultBalanceKoinERC20() {
        try {
          elEthKoinBalance.innerText = "Loading koin (ERC20 token) balance..."
          const koinErc20 = {
            address: "0x66d28cb58487a7609877550e1a34691810a6b9fc",
            abi: ["function balanceOf(address) view returns (uint)"],
          }
          const ethContract = new ethers.Contract(
            koinErc20.address,
            koinErc20.abi,
            getMetamaskProvider()
          )
          const balance = await ethContract.balanceOf(inputEthAddress.value)
          elEthAddress.innerText = inputEthAddress.value
          elEthKoinBalance.innerText = `${ethers.utils.formatUnits(
            balance,
            8
          )}`
        } catch (error) {
          elEthKoinBalance.innerText = `Balance Error: ${error.message}`
          notification.show(`Error: ${error.message}`)
          console.error(error)
        }
      }

      function getClaimContract() {
        return new Contract({
          id: "15XWhAV99fSmz8z9vrA5j9rwwBpXMPHkBQ",
          abi: {
            methods: {
              claim: {
                argument: "claim_arguments",
                return: "claim_result",
                entry_point: 0xdd1b3c31,
                read_only: false,
              },
              get_info: {
                argument: "get_info_arguments",
                return: "get_info_result",
                entry_point: 0xbd7f6850,
                read_only: true,
              },
              check_claim: {
                argument: "check_claim_arguments",
                return: "check_claim_result",
                entry_point: 0x2ac66b4c,
                read_only: true,
              },
            },
            koilib_types: {
              nested: {
                koinos: {
                  nested: {
                    contracts: {
                      nested: {
                        claim: {
                          options: {
                            go_package:
                              "github.com/koinos/koinos-proto-golang/koinos/contracts/claim",
                          },
                          nested: {
                            claim_info: {
                              fields: {
                                total_eth_accounts: {
                                  type: "uint32",
                                  id: 1,
                                },
                                eth_accounts_claimed: {
                                  type: "uint32",
                                  id: 2,
                                },
                                total_koin: {
                                  type: "uint64",
                                  id: 3,
                                },
                                koin_claimed: {
                                  type: "uint64",
                                  id: 4,
                                },
                              },
                            },
                            claim_status: {
                              fields: {
                                token_amount: {
                                  type: "uint64",
                                  id: 1,
                                  options: {
                                    jstype: "JS_STRING",
                                  },
                                },
                                claimed: {
                                  type: "bool",
                                  id: 2,
                                },
                              },
                            },
                            claim_arguments: {
                              fields: {
                                eth_address: {
                                  type: "bytes",
                                  id: 1,
                                  options: {
                                    "(btype)": "HEX",
                                  },
                                },
                                koin_address: {
                                  type: "bytes",
                                  id: 2,
                                  options: {
                                    "(btype)": "ADDRESS",
                                  },
                                },
                                signature: {
                                  type: "bytes",
                                  id: 3,
                                },
                              },
                            },
                            claim_result: {
                              fields: {},
                            },
                            get_info_arguments: {
                              fields: {},
                            },
                            get_info_result: {
                              fields: {
                                value: {
                                  type: "claim_info",
                                  id: 1,
                                },
                              },
                            },
                            check_claim_arguments: {
                              fields: {
                                eth_address: {
                                  type: "bytes",
                                  id: 1,
                                  options: {
                                    "(btype)": "HEX",
                                  },
                                },
                              },
                            },
                            check_claim_result: {
                              fields: {
                                value: {
                                  type: "claim_status",
                                  id: 1,
                                },
                              },
                            },
                          },
                        },
                      },
                    },
                  },
                },
              },
            },
          },
          provider: kondor.provider,
          signer: kondor.getSigner(koinAddress),
        })
      }

      async function consultGeneralInfo() {
        try {
          const claimContract = getClaimContract().functions
          const { result: { value: info } } = await claimContract.get_info({});
          document.getElementById("totalEthAccounts").innerText = info.total_eth_accounts;
          document.getElementById("ethAccountsClaimed").innerText = info.eth_accounts_claimed;
          document.getElementById("totalKoin").innerText = Number(utils.formatUnits(info.total_koin, 8)).toLocaleString('en-US', { maximumFractionDigits: 8});
          document.getElementById("koinClaimed").innerText = Number(utils.formatUnits(info.koin_claimed, 8)).toLocaleString('en-US', { maximumFractionDigits: 8});
        } catch (error) {
          elClaimed.innerText = `Claim Error: ${error.message}`
        }
      }

      async function consultClaim() {
        consultBalanceKoinERC20()
        try {
          elClaimed.innerText = "Loading claim status..."
          const claimContract = getClaimContract().functions
          const { result: claim } = await claimContract.check_claim({
            eth_address: inputEthAddress.value,
          })
          elEthAddress.innerText = inputEthAddress.value
          if (!claim || !claim.value) {
            const errorMessage = `No claim data found for address ${inputEthAddress.value}`
            elClaimed.innerText = errorMessage
            console.log(claim)
            throw new Error(errorMessage)
          }
          elClaimed.innerText = `${utils.formatUnits(
            claim.value.token_amount,
            8
          )} tKoins ${
            claim.value.claimed ? "already claimed" : "ready to be claimed"
          }`
        } catch (error) {
          elClaimed.innerText = `Claim Error: ${error.message}`
        }
      }

      async function connectMetamask() {
        notification.hide()
        try {
          getMetamaskProvider()
          const accounts = await ethereum.request({
            method: "eth_requestAccounts",
          })
          inputEthAddress.value = accounts[0]
          elEthAddress.innerText = accounts[0]
          consultClaim()
        } catch (error) {
          notification.show(`MM Connect Error: ${error.message}`)
          console.error(error)
        }
      }

      async function connectKondor() {
        notification.hide()
        try {
          elKoinAddress.innerText = ""
          const accounts = await kondor.getAccounts()
          if (accounts.length === 0) throw new Error("No account selected")
          koinAddress = accounts[0].address
          elKoinAddress.innerText = koinAddress
        } catch (error) {
          elKoinAddress.innerText = `Error: ${error.message}`
          notification.show(`Kondor Connect Error: ${error.message}`)
          console.error(error)
        }
      }

      async function claimKoins() {
        notification.hide()
        try {
          const signer = getMetamaskProvider().getSigner()
          const message = `claim tkoins ${inputEthAddress.value}:${koinAddress}`
          elEthAddress.innerText = inputEthAddress.value
          const signature = await signer.signMessage(message)

          console.log(
            JSON.stringify(
              {
                address: inputEthAddress.value,
                msg: ethers.utils.hexlify(ethers.utils.toUtf8Bytes(message)),
                sig: signature,
                version: "3",
                signer: "Metamask",
              },
              null,
              2
            )
          )

          const claimContract = getClaimContract().functions
          const { r, s, recoveryParam } = ethers.utils.splitSignature(signature)
          const compactSignature =
            Number(31 + recoveryParam).toString(16) + r.slice(2) + s.slice(2)
          const { transaction, receipt } = await claimContract.claim({
            eth_address: inputEthAddress.value,
            koin_address: koinAddress,
            signature: utils.encodeBase64url(
              utils.toUint8Array(compactSignature)
            ),
          })

          console.log(`transaction ${transaction.id} submitted. Receipt:`)
          console.log(receipt)

          notification.show(
            `transaction ${transaction.id} submitted. Waiting to be mined`
          )

          // wait to be mined
          const blockNumber = await transaction.wait()
          console.log(`Mined in block ${blockNumber}`)
          notification.show(
            `Congratulations! Your tokens have been claimed! (<a href="https://koinosexplorer.com/tx/${transaction.id}">transaction</a>)`
          )
        } catch (error) {
          notification.show(`Claim Error: ${error.message}`)
          console.error(error)
        }
      }
    </script>
  </body>
</html>
