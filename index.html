<html>
  <head>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="header">
      <div class="logo">
        <svg width="40%" height="40%" viewBox="0 0 3522 1037" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
          <g transform="matrix(1,0,0,1,-11689,-3192)">
              <g id="koinos-logo-rev4" transform="matrix(1.70692,0,0,1.07032,11689.7,1567.25)">
                  <rect x="0" y="1518.87" width="2062.72" height="967.285" style="fill:none;"/>
                  <g transform="matrix(1.5654,0,0,1.42069,-604.704,-852.556)">
                      <g>
                          <g transform="matrix(1.24313,0,0,1.98277,-5792.99,-1905.96)">
                              <g transform="matrix(218.726,0,0,206.172,5263.26,2046.97)">
                                  <path d="M0.073,-0L0.073,-0.7L0.181,-0.7L0.181,-0.409L0.197,-0.409L0.458,-0.7L0.599,-0.7L0.283,-0.355L0.61,-0L0.465,-0L0.197,-0.297L0.181,-0.297L0.181,-0L0.073,-0Z" style="fill:rgb(37,23,78);fill-rule:nonzero;"/>
                              </g>
                              <g transform="matrix(218.726,0,0,206.172,5383.5,2046.97)">
                                  <path d="M0.336,0.014C0.25,0.014 0.182,-0.01 0.131,-0.059C0.08,-0.107 0.055,-0.177 0.055,-0.268L0.055,-0.432C0.055,-0.523 0.08,-0.593 0.131,-0.642C0.182,-0.69 0.25,-0.714 0.336,-0.714C0.422,-0.714 0.491,-0.69 0.542,-0.642C0.592,-0.593 0.618,-0.523 0.618,-0.432L0.618,-0.268C0.618,-0.177 0.592,-0.107 0.542,-0.059C0.491,-0.01 0.422,0.014 0.336,0.014ZM0.336,-0.083C0.391,-0.083 0.434,-0.099 0.464,-0.132C0.494,-0.164 0.509,-0.208 0.509,-0.264L0.509,-0.436C0.509,-0.492 0.494,-0.536 0.464,-0.569C0.434,-0.601 0.391,-0.617 0.336,-0.617C0.282,-0.617 0.24,-0.601 0.209,-0.569C0.178,-0.536 0.163,-0.492 0.163,-0.436L0.163,-0.264C0.163,-0.208 0.178,-0.164 0.209,-0.132C0.24,-0.099 0.282,-0.083 0.336,-0.083Z" style="fill:rgb(37,23,78);fill-rule:nonzero;"/>
                              </g>
                              <g transform="matrix(218.726,0,0,206.172,5521.95,2046.97)">
                                  <rect x="0.073" y="-0.7" width="0.108" height="0.7" style="fill:rgb(37,23,78);fill-rule:nonzero;"/>
                              </g>
                              <g transform="matrix(218.726,0,0,206.172,5568.76,2046.97)">
                                  <path d="M0.073,-0L0.073,-0.7L0.281,-0.7L0.471,-0.072L0.487,-0.072L0.487,-0.7L0.594,-0.7L0.594,-0L0.386,-0L0.196,-0.629L0.18,-0.629L0.18,-0L0.073,-0Z" style="fill:rgb(37,23,78);fill-rule:nonzero;"/>
                              </g>
                              <g transform="matrix(218.726,0,0,206.172,5705.9,2046.97)">
                                  <path d="M0.336,0.014C0.25,0.014 0.182,-0.01 0.131,-0.059C0.08,-0.107 0.055,-0.177 0.055,-0.268L0.055,-0.432C0.055,-0.523 0.08,-0.593 0.131,-0.642C0.182,-0.69 0.25,-0.714 0.336,-0.714C0.422,-0.714 0.491,-0.69 0.542,-0.642C0.592,-0.593 0.618,-0.523 0.618,-0.432L0.618,-0.268C0.618,-0.177 0.592,-0.107 0.542,-0.059C0.491,-0.01 0.422,0.014 0.336,0.014ZM0.336,-0.083C0.391,-0.083 0.434,-0.099 0.464,-0.132C0.494,-0.164 0.509,-0.208 0.509,-0.264L0.509,-0.436C0.509,-0.492 0.494,-0.536 0.464,-0.569C0.434,-0.601 0.391,-0.617 0.336,-0.617C0.282,-0.617 0.24,-0.601 0.209,-0.569C0.178,-0.536 0.163,-0.492 0.163,-0.436L0.163,-0.264C0.163,-0.208 0.178,-0.164 0.209,-0.132C0.24,-0.099 0.282,-0.083 0.336,-0.083Z" style="fill:rgb(37,23,78);fill-rule:nonzero;"/>
                              </g>
                              <g transform="matrix(218.726,0,0,206.172,5844.35,2046.97)">
                                  <path d="M0.311,0.014C0.258,0.014 0.212,0.005 0.171,-0.014C0.13,-0.033 0.098,-0.06 0.076,-0.097C0.053,-0.133 0.041,-0.177 0.041,-0.229L0.041,-0.254L0.148,-0.254L0.148,-0.229C0.148,-0.18 0.163,-0.143 0.193,-0.118C0.222,-0.093 0.262,-0.081 0.311,-0.081C0.361,-0.081 0.399,-0.092 0.424,-0.113C0.449,-0.134 0.462,-0.161 0.462,-0.194C0.462,-0.216 0.456,-0.234 0.444,-0.248C0.432,-0.262 0.415,-0.273 0.393,-0.282C0.371,-0.29 0.345,-0.298 0.314,-0.305L0.277,-0.314C0.232,-0.325 0.194,-0.338 0.161,-0.354C0.128,-0.369 0.102,-0.39 0.084,-0.416C0.066,-0.442 0.057,-0.475 0.057,-0.516C0.057,-0.557 0.067,-0.593 0.088,-0.622C0.108,-0.651 0.136,-0.674 0.172,-0.69C0.208,-0.706 0.25,-0.714 0.299,-0.714C0.348,-0.714 0.391,-0.706 0.43,-0.689C0.468,-0.672 0.498,-0.648 0.52,-0.615C0.542,-0.582 0.553,-0.541 0.553,-0.492L0.553,-0.456L0.446,-0.456L0.446,-0.492C0.446,-0.522 0.44,-0.546 0.428,-0.565C0.415,-0.584 0.398,-0.597 0.376,-0.606C0.354,-0.615 0.328,-0.619 0.299,-0.619C0.256,-0.619 0.223,-0.61 0.2,-0.593C0.176,-0.575 0.164,-0.55 0.164,-0.519C0.164,-0.498 0.169,-0.48 0.18,-0.467C0.19,-0.453 0.205,-0.442 0.225,-0.433C0.245,-0.424 0.27,-0.417 0.3,-0.41L0.337,-0.401C0.382,-0.391 0.422,-0.378 0.457,-0.363C0.492,-0.347 0.519,-0.326 0.539,-0.299C0.559,-0.272 0.569,-0.238 0.569,-0.196C0.569,-0.154 0.559,-0.117 0.538,-0.086C0.517,-0.055 0.487,-0.03 0.448,-0.013C0.409,0.005 0.364,0.014 0.311,0.014Z" style="fill:rgb(37,23,78);fill-rule:nonzero;"/>
                              </g>
                          </g>
                          <g transform="matrix(0.560382,0,0,0.982161,260.821,-1414.98)">
                              <g>
                                  <path d="M345.135,3373.44C345.135,3373.44 540,3260.93 540,3260.93L734.865,3373.44C735.406,3373.75 735.74,3374.33 735.74,3374.95L735.74,3598.95C735.74,3599.58 735.406,3600.15 734.865,3600.47L540.875,3712.47L540.85,3712.48L540.824,3712.49L540.798,3712.51L540.772,3712.52L540.746,3712.53L540.72,3712.55L540.693,3712.56L540.667,3712.57L540.64,3712.58L540.613,3712.59L540.586,3712.6L540.559,3712.61L540.532,3712.62L540.504,3712.63L540.477,3712.64L540.449,3712.64L540.422,3712.65L540.394,3712.66L540.366,3712.66L540.338,3712.67L540.31,3712.67L540.282,3712.68L540.254,3712.68L540.226,3712.69L540.198,3712.69L540.165,3712.69L540.138,3712.7L540.108,3712.7L540.071,3712.7L540.042,3712.7L540.014,3712.7L539.986,3712.7L539.958,3712.7L539.925,3712.7L539.895,3712.7L539.858,3712.7L539.83,3712.69L539.802,3712.69L539.774,3712.69L539.746,3712.68L539.718,3712.68L539.69,3712.67L539.662,3712.67L539.634,3712.66L539.606,3712.66L539.578,3712.65L539.551,3712.64L539.523,3712.64L539.496,3712.63L539.468,3712.62L539.441,3712.61L539.414,3712.6L539.387,3712.59L539.36,3712.58L539.333,3712.57L539.307,3712.56L539.28,3712.55L539.254,3712.53L539.228,3712.52L539.202,3712.51L539.176,3712.49L539.15,3712.48L539.125,3712.47C539.125,3712.47 345.135,3600.47 345.135,3600.47C344.594,3600.15 344.26,3599.58 344.26,3598.95L344.26,3374.95C344.26,3374.33 344.594,3373.75 345.135,3373.44ZM347.76,3597.94L538.25,3707.92L538.25,3583.96L455.987,3536.47C455.445,3536.15 455.112,3535.58 455.112,3534.95L455.112,3439.96L347.76,3377.98L347.76,3597.94ZM624.888,3439.96L624.888,3535.96L541.75,3583.96L541.75,3707.92L732.24,3597.94L732.24,3377.98L624.888,3439.96ZM458.612,3533.94L538.25,3579.92L538.25,3487.96L458.612,3441.98L458.612,3533.94ZM621.388,3442.63L541.75,3488.61L541.75,3579.92L621.388,3533.94L621.388,3442.63ZM460.362,3438.95L540,3484.93L619.638,3438.95L540,3392.97L460.362,3438.95ZM540,3388.93L623.138,3436.93L730.49,3374.95L540,3264.97L349.51,3374.95L456.862,3436.93L540,3388.93Z" style="fill:rgb(106,0,244);stroke:rgb(106,0,244);stroke-width:21.4px;"/>
                              </g>
                          </g>
                      </g>
                  </g>
              </g>
          </g>
      </svg>
      </div>
      <div class="info flex-row">
        <div class="mini-card flex-row">
          <div class="title">
            <img src="./static/images/ethereum-icon.svg" alt="">
            ERC20
          </div>
          <div class="label">Accounts</div>
          <div class="value">3,367</div>
          <div class="label">Claimed</div>
          <div class="value">0</div>
        </div>
        <div class="mini-card flex-row">
          <div class="title">
            <img src="./static/images/koinos-icon-purple.svg" alt="">
            KOIN
          </div>
          <div class="label">Tokens</div>
          <div class="value">99,578,207</div>
          <div class="label">Claimed</div>
          <div class="value">0</div>
        </div>
      </div>
    </div>
    <div class="wrapper">
      <div class="left">
        <h2>KOIN Token Claiming</h2>
        <p>Welcome to the Koinos token claiming application. Here you will be able to connect your ERC20 wallet containing KOIN and claim your native KOIN tokens on the Koinos blockchain.</p>
        <div class="group">
          <p><div class="bold">Step One:</div> Connect your metamask wallet containing the KOIN ERC20 tokens</p>
          <button onclick="connectMetamask()"><img src="./static/images/metamask-logo.svg" alt=""> Connect Metamask</button>
        </div>
          <div class="group">
            <p><div class="bold">Step Two:</div> check the address containing the KOIN ERC20 tokens.</p>
            <div class="input-group">
              <input type="text" id="ethAddress" placeholder="Ethereum Address"/>
              <button onclick="consultClaim()" class="">Verify</button>
            </div>
          </div>
        <div class="group">
          <p><div class="bold">Step Three:</div> Connect your Kondor wallet</p>
          <button onclick="connectKondor()"> <img src="./static/images/kondor-icon.svg" alt=""> Connect Kondor</button>
        </div>
        <div id="group-claim" class="group">
          <p><div class="bold">Step Four:</div> Claim your KOIN tokens</p>
          <button onclick="claimKoins()" class="button-85">Claim KOIN</button>
        </div>
      </div>
      <div class="right">
        <div class="message">
          <div id="ethKoinBalance"></div>
          <div id="claimed"></div>
          <div id="message"></div>
          <div id="koinAddress"></div>
        </div>
      </div>
    </div>
    <script
      src="https://cdn.ethers.io/lib/ethers-5.0.umd.min.js"
      type="text/javascript"
    ></script>
    <script src="js/kondor.js"></script>
    <script src="js/koinos.js"></script>
    <script>
      const inputEthAddress = document.getElementById("ethAddress")
      const elMessage = document.getElementById("message")
      const elEthKoinBalance = document.getElementById("ethKoinBalance")
      const elKoinAddress = document.getElementById("koinAddress")
      const elClaimed = document.getElementById("claimed")
      let koinAddress
      let metamaskProvider

      const notification = {
        hide: () => elMessage.setAttribute("style", "display:none;"),
        show: (msg) => {
          elMessage.innerHTML = msg
          elMessage.setAttribute("style", "display:block;")
        },
      }
      notification.hide()

      function getMetamaskProvider() {
        if (typeof window.ethereum === "undefined") {
          throw new Error("Metamask is not installed")
        }
        return new ethers.providers.Web3Provider(window.ethereum)
      }

      async function consultBalanceKoinERC20() {
        try {
          elEthKoinBalance.innerText = "Loading koin (ERC20 token) balance..."
          const koinErc20 = {
            address: "0x66d28cb58487a7609877550e1a34691810a6b9fc",
            abi: ["function balanceOf(address) view returns (uint)"],
          }
          const ethContract = new ethers.Contract(
            koinErc20.address,
            koinErc20.abi,
            getMetamaskProvider()
          )
          const balance = await ethContract.balanceOf(inputEthAddress.value)
          elEthKoinBalance.innerText = `${ethers.utils.formatUnits(
            balance,
            8
          )} koins (ERC20 token)`
        } catch (error) {
          elEthKoinBalance.innerText = `Error: ${error.message}`
          notification.show(`Error: ${error.message}`)
          console.error(error)
        }
      }

      function getClaimContract() {
        return new Contract({
          id: "15XWhAV99fSmz8z9vrA5j9rwwBpXMPHkBQ",
          abi: {
            methods: {
              claim: {
                argument: "claim_arguments",
                return: "claim_result",
                entry_point: 0xdd1b3c31,
                read_only: false,
              },
              get_info: {
                argument: "get_info_arguments",
                return: "get_info_result",
                entry_point: 0xbd7f6850,
                read_only: true,
              },
              check_claim: {
                argument: "check_claim_arguments",
                return: "check_claim_result",
                entry_point: 0x2ac66b4c,
                read_only: true,
              },
            },
            koilib_types: {
              nested: {
                koinos: {
                  nested: {
                    contracts: {
                      nested: {
                        claim: {
                          options: {
                            go_package:
                              "github.com/koinos/koinos-proto-golang/koinos/contracts/claim",
                          },
                          nested: {
                            claim_info: {
                              fields: {
                                total_eth_accounts: {
                                  type: "uint32",
                                  id: 1,
                                },
                                eth_accounts_claimed: {
                                  type: "uint32",
                                  id: 2,
                                },
                                total_koin: {
                                  type: "uint64",
                                  id: 3,
                                },
                                koin_claimed: {
                                  type: "uint64",
                                  id: 4,
                                },
                              },
                            },
                            claim_status: {
                              fields: {
                                token_amount: {
                                  type: "uint64",
                                  id: 1,
                                  options: {
                                    jstype: "JS_STRING",
                                  },
                                },
                                claimed: {
                                  type: "bool",
                                  id: 2,
                                },
                              },
                            },
                            claim_arguments: {
                              fields: {
                                eth_address: {
                                  type: "bytes",
                                  id: 1,
                                  options: {
                                    "(btype)": "HEX",
                                  },
                                },
                                koin_address: {
                                  type: "bytes",
                                  id: 2,
                                  options: {
                                    "(btype)": "ADDRESS",
                                  },
                                },
                                signature: {
                                  type: "bytes",
                                  id: 3,
                                },
                              },
                            },
                            claim_result: {
                              fields: {},
                            },
                            get_info_arguments: {
                              fields: {},
                            },
                            get_info_result: {
                              fields: {
                                value: {
                                  type: "claim_info",
                                  id: 1,
                                },
                              },
                            },
                            check_claim_arguments: {
                              fields: {
                                eth_address: {
                                  type: "bytes",
                                  id: 1,
                                  options: {
                                    "(btype)": "HEX",
                                  },
                                },
                              },
                            },
                            check_claim_result: {
                              fields: {
                                value: {
                                  type: "claim_status",
                                  id: 1,
                                },
                              },
                            },
                          },
                        },
                      },
                    },
                  },
                },
              },
            },
          },
          provider: kondor.provider,
          signer: kondor.getSigner(koinAddress),
        })
      }

      async function consultClaim() {
        consultBalanceKoinERC20()
        try {
          elClaimed.innerText = "Loading claim status..."
          const claimContract = getClaimContract().functions
          const { result: claim } = await claimContract.check_claim({
            eth_address: inputEthAddress.value,
          })
          if (!claim || !claim.value) {
            const errorMessage = `No claim data found for address ${inputEthAddress.value}`
            elClaimed.innerText = errorMessage
            console.log(claim)
            throw new Error(errorMessage)
          }
          elClaimed.innerText = `${utils.formatUnits(
            claim.value.token_amount,
            8
          )} tKoins ${
            claim.value.claimed ? "already claimed" : "ready to be claimed"
          }`
        } catch (error) {
          elClaimed.innerText = `Error: ${error.message}`
        }
      }

      async function connectMetamask() {
        notification.hide()
        try {
          getMetamaskProvider()
          const accounts = await ethereum.request({
            method: "eth_requestAccounts",
          })
          inputEthAddress.value = accounts[0]
          consultClaim()
        } catch (error) {
          notification.show(`Error: ${error.message}`)
          console.error(error)
        }
      }

      async function connectKondor() {
        notification.hide()
        try {
          elKoinAddress.innerText = ""
          const accounts = await kondor.getAccounts()
          if (accounts.length === 0) throw new Error("No account selected")
          koinAddress = accounts[0].address
          elKoinAddress.innerText = koinAddress
        } catch (error) {
          elKoinAddress.innerText = `Error: ${error.message}`
          notification.show(`Error: ${error.message}`)
          console.error(error)
        }
      }

      async function claimKoins() {
        notification.hide()
        try {
          const signer = getMetamaskProvider().getSigner()
          const message = `claim koins ${inputEthAddress.value}:${koinAddress}`
          const signature = await signer.signMessage(message)

          console.log(
            JSON.stringify(
              {
                address: inputEthAddress.value,
                msg: ethers.utils.hexlify(ethers.utils.toUtf8Bytes(message)),
                sig: signature,
                version: "3",
                signer: "Metamask",
              },
              null,
              2
            )
          )

          const claimContract = getClaimContract().functions
          const { r, s, recoveryParam } = ethers.utils.splitSignature(signature)
          const compactSignature =
            Number(31 + recoveryParam).toString(16) + r.slice(2) + s.slice(2)
          const { transaction, receipt } = await claimContract.claim({
            eth_address: inputEthAddress.value,
            koin_address: koinAddress,
            signature: utils.encodeBase64url(
              utils.toUint8Array(compactSignature)
            ),
          })

          console.log(`transaction ${transaction.id} submitted. Receipt:`)
          console.log(receipt)

          notification.show(
            `transaction ${transaction.id} submitted. Waiting to be mined`
          )

          // wait to be mined
          const blockNumber = await transaction.wait()
          console.log(`Mined in block ${blockNumber}`)
          notification.show(
            `Congratulations! Your tokens have been claimed! (<a href="https://koinosexplorer.com/tx/${transaction.id}">transaction</a>)`
          )
        } catch (error) {
          notification.show(`Error: ${error.message}`)
          console.error(error)
        }
      }
    </script>
  </body>
</html>
