<html>
  <head>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <h2>Consult claim</h2>
    <div class="group">
      <label for="consult">Ethereum address</label>
      <input type="text" id="inputConsult" />
      <button onclick="consult()">Consult</button>
    </div>
    <div id="resultConsult"></div>
    <h2>Claim koins</h2>
    <div class="group">
      <button onclick="connectMetamask()">Connect metamask</button>
      <div id="ethAddress"></div>
      <div id="ethKoinBalance"></div>
    </div>
    <div class="group">
      <button onclick="connectKondor()">Connect kondor</button>
      <div id="koinAddress"></div>
      <div id="claimed"></div>
    </div>
    <div id="group-claim">
      <button onclick="claimKoins()">Claim</button>
    </div>
    <div id="message"></div>

    <script src="https://cdn.ethers.io/lib/ethers-5.0.umd.min.js" type="text/javascript">
    </script>
    <script src="js/kondor.min.js"></script>
    <script src="js/koinos.min.js"></script>
    <script>
      const inputConsult = document.getElementById("inputConsult");
      const elMessage = document.getElementById("message");
      const elEthAddress = document.getElementById("ethAddress");
      const elEthKoinBalance = document.getElementById("ethKoinBalance");
      const elKoinAddress = document.getElementById("koinAddress");
      const elClaimed = document.getElementById("claimed");
      let koinAddress;
      let ethAddress;
      let metamaskProvider;

      const notification = {
        hide: () => elMessage.setAttribute("style", "display:none;"),
        show: (msg) => {
          elResult.innerHTML = msg;
          elResult.setAttribute("style", "display:block;");
        },
      };
      notification.hide();

      function getClaimContract() {
        return new Contract({
          id: "19JntSm8pSNETT9aHTwAUHC5RMoaSmgZPJ",
          abi: utils.tokenAbi, // todo: update abi
          provider: kondor.provider,
          signer: kondor.getSigner(koinAddress),
        });
      }

      async function connectMetamask() {
        notification.hide();
        try {
          if (typeof window.ethereum === "undefined") {
            throw new Error("Metamask is not installed");
          }
          const [ethAccount] = await ethereum.request({ method: "eth_requestAccounts" });
          elEthAddress.innerText = ethAccount;
          metamaskProvider = new ethers.providers.Web3Provider(window.ethereum);
          const koinErc20 = {
            address: "0x66d28cb58487a7609877550e1a34691810a6b9fc",
            abi: ["function balanceOf(address) view returns (uint)"],
          };
          const ethContract = new ethers.Contract(koinErc20.address, koinErc20.abi, metamaskProvider);
          const balance = await ethContract.balanceOf(ethAccount);
          elEthKoinBalance.innerText = `${ethers.utils.formatUnits(balance, 8)} koins`;
          const claimContract = getClaimContract().functions;
          const claim = await claimContract.check_claim({
            eth_address: ethAddress,
          });
          if (!claim || !claim.value) {
            const errorMessage = `No claim data found for address ${ethAddress}`;
            console.log(errorMessage);
            console.log(claim);
            throw new Error(errorMessage);
          }
          elClaimed.innerText = `${utils.formatUnits(claim.value.token_amount)} tKoins ${clam.value.claimed ? "already claimed" : "ready to be claimed"}`;
        } catch (error) {
          notification.show(`Error: ${error.message}`);
          console.error(error)
        }
      }

      async function connectKondor() {
        notification.hide();
        try {
          const accounts = await kondor.getAccounts();
          if (accounts.length === 0)
            throw new Error("No account selected");
          koinAddress = accounts[0].address;
          console.log(accounts);
          elKoinAddress.innerHTML = koinAddress;
        } catch (error) {
          notification.show(`Error: ${error.message}`);
          console.error(error);
        }
      }

      async function claimKoins() {
        notification.hide();
        try {
          const signer = metamaskProvider.getSigner();
          const message = `claim koins ${ethAccount}:${koinAddress}`;
          const signature = await signer.signMessage(message);
          
          console.log(signature);
          console.log(JSON.stringify({
            address: ethAccount,
            msg: ethers.utils.hexlify(ethers.utils.toUtf8Bytes(message)),
            sig: signature,
            version: "3",
            signer: "MEW"
          }));

          const claimContract = getClaimContract().functions;
          const { transaction, receipt } = await claim.claim({
            eth_address: ethAddress,
            koin_address: koinAddress,
            signature,
          })
          
          console.log(`transaction ${transaction.id} submitted. Receipt:`);
          console.log(receipt);

          if (receipt.logs) throw new Error(receipt.logs.join(", "));

          notification.show(
            `transaction ${transaction.id} submitted. Waiting to be mined`
          );

          // wait to be mined
          const blockNumber = await transaction.wait();
          console.log(`Mined in block ${blockNumber}`);
          notification.show(
            `transaction ${transaction.id} submitted. Mined in block ${blockNumber}`
          );
        } catch (error) {
          notification.show(`Error: ${error.message}`);
          console.error(error);
        }
      }
    </script>
  </body>
</html>
